---
layout:       post
title:        "å¼‚æ­¥ä¸Promise"
subtitle:     "æˆ‘æ‰¿è¯º,æ— è®ºç”Ÿè€ç—…æ­»éƒ½å°†ä¸ä½ ä¸ç¦»ä¸å¼ƒ"
date:         2018-06-21 12:00:00
author:       "Lorry"
header-mask:  0.3
header-img:   '/img/back/promise.jpg'
catalog:      true
multilingual: false
tags:
    - JavaScript
---

Promiseæ˜¯ES6ä¸­ä¸€ä¸ªå¾ˆé‡è¦çš„å¼‚æ­¥è¯­æ³•.å¯ä»¥å¾ˆä¼˜é›…çš„è§£å†³å¼‚æ­¥,å›è°ƒç­‰é—®é¢˜.

# é¦–å…ˆæ¥å¼•å…¥ç”Ÿæˆå™¨ generator

çœ‹ä¸€ä¸ªåŒæ­¥çš„ä¾‹å­:ä»serverç«¯è·å–jsonæ•°æ®

```js
try{
  // è·å–æ•´ä¸ªé¡¹ç›®
  let project = syncGetJSON('lorry.com');
  // è·å–é¡¹ç›®ä¸­çš„æŸä¸€ä¸ªä»»åŠ¡
  let mission = syncGetJSON(project[0].missionURL);
  // è·å–è¯¥ä»»åŠ¡ä¸­çš„å…·ä½“ä¿¡æ¯
  let missionDetail = syncGetJSON(mission[0].detailURL);
} catch(e) {
  console.error(e)
}
```
ä¸Šè¿°ä¾‹å­çš„å†™æ³•çœ‹èµ·æ¥ååˆ†çš„å¥½ç†è§£,ä½†ä¹Ÿæœ‰ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜æ˜¯å› ä¸ºå†™çš„éƒ½æ˜¯åŒæ­¥ä»£ç ,æ‰€ä»¥ä¼šé˜»å¡æ‰æ•´ä¸ªé€»è¾‘çš„è¿è¡Œ.å¦‚æœprojectçš„å†…å®¹å¾ˆå¤§,éœ€è¦10s,é‚£ä¹ˆæˆ‘ä»¬çš„ç¨‹åºå°±è¦ç­‰å¾…10såæ‰èƒ½ç»§ç»­è¿è¡Œ,ç”¨æˆ·äº¤äº’ååˆ†çš„ä¸å‹å¥½.

## æ‰€ä»¥æœ‰äº†å¼‚æ­¥

```js
getJSON('lorry.com', (err, project) => {
  if (err) {
    console.error(err)
    return
  }
  getJSON(project[0].missionURL, (err, mission) => {
    if (err) {
      console.error(err)
      return
    }
    getJSON(mission.detailURL, (err, detail) => {
      if(err) {
        console.error(err)
        return
      }
      console.log(detail)
    })
  })
})
```

ä¸Šè¿°ä»£ç å¯ä»¥è§£å†³ä¹‹å‰çš„é˜»å¡é—®é¢˜,ä½†æ˜¯æ˜¯ä¸æ˜¯çœ‹èµ·æ¥ååˆ†çš„ä¸ä¼˜é›…?æœ‰è®¸å¤šçš„erråˆ¤æ–­,ç„¶åä¸€å±‚ä¸€å±‚çš„åµŒå¥—(å›è°ƒåœ°ç‹± `callback hell`)

äºæ˜¯ä¹,ç”Ÿæˆå™¨ `generator`æ¨ªç©ºå‡ºä¸–,å¦‚æœèƒ½å¤Ÿå¾ˆæ¸…æ¥šçš„ç†è§£ä¸‹é¢è¿™æ®µä»£ç ,é‚£ä¹ˆä½ å¯ä»¥å¿«é€Ÿæµè§ˆ,æˆ–è®¸è¿™äº›éƒ½æ˜¯ä½ å·²ç»çŸ¥é“çš„çŸ¥è¯†äº†.

```js
// getJSONä¸ºä¸€ä¸ªPromise
async(function* () {
  try {
    const project = yield getJSON('lorry.com')
    const mission = yield getJSON(project[0].missionURL)
    const detail = yield getJSON(misson.detailURL)
  } catch(e) {
    console.error(e)
  }
})
function async (generator) {
  let iterator = generator();
  function handle(iteratorResult) {
    if (iterator.done) { return }
    const iteratorValue = iteratorResult.value
    if(iteratorValue instanceof Promise) {
      iteratorValue.then(res => handle(iterator.next(res))).catch(err => iterator.throw(err))
    }
  }
}
try {
  handle(iterator.next())
} catch(e) {
  iterator.throw(e)
}
```
æ˜¯ä¸æ˜¯è·Ÿç¬¬ä¸€ä¸ªçš„å†™æ³•å¾ˆåƒ?

### generatorå…¶å®å°±ä¸¤ä¸ªä¸œè¥¿,`*` å’Œ `yield`

## 1 for-ofå¯ä»¥éå†æ‰€æœ‰çš„yield

```js
function* example() {
  yield(1)
  yield(2)
  yield(3)
}

for (let num of example()) {
  console.log(num) // æ‰“å°1,2,3
}
```
## 2 ä½¿ç”¨next()å¯¹generatorè¿›è¡Œæ§åˆ¶, .valueè¡¨ç¤ºyieldçš„å€¼.doneå±æ€§è¡¨ç¤ºç»ˆæ­¢æ¡ä»¶

```js
let nums = example()   // numsä¸ºä¸€ä¸ªè¿­ä»£å™¨(iterator)
let num1 = nums.next().value // 1
let num2 = nums.next().value // 2
let num3 = nums.next().value // 3
let num4 = nums.next().value // undefined
console.log(nums.done) // true
```
ç°åœ¨å¯ä»¥ç”¨whileæ¥è¿­ä»£äº†,å…¶å®for-ofçš„å°±æ˜¯ä»¥ä¸‹whileçš„ä¸€ä¸ªè¯­æ³•ç³–.
```js
while(!(item = nums.next()).done) {
  console.log(item // 1,2,3
}
```
## 3 generatorä¹‹é—´çš„åµŒå¥— `yield`è¡¨ç¤ºå¦ä¸€ä¸ªç”Ÿæˆå™¨,ä¼šæŒ‰é¡ºåºå°†åµŒå¥—ç”Ÿæˆå™¨çš„è¿­ä»£å®Œ,å†å¾€ä¸‹æ‰§è¡Œ
```js
function* example2() {
  yield* example1();
  yield 4;
  yield 5;
}

for (let num of example2) {
  console.log(num) //1,2,3,4,5
}
```

## 4 å¯ä»¥åœ¨generatorä¸­å†™`while(true)`

```js
function* count() {
  let id = 1;
  while(true) {
    yield id++
  }
}

let idIterator = count()
idIterator.next().value // 1
idIterator.next().value // 2
// ä¸ä½¿ç”¨ç”Ÿæˆå™¨çš„å®ç°æ–¹å¼,ä¼šé€ æˆå˜é‡çš„æ±¡æŸ“
function() {
  let id = 1; // æˆ‘æœ¬ä¸å±äºè¿™é‡Œ.
  function count() {
    return id++
  }
  console.log(count())
}

```
è¿™ä¸ªç”Ÿæˆå™¨æ°¸è¿œä¸ä¼šç»“æŸ,`.done`æ°¸è¿œä¸º`false`

## 5 ä½¿ç”¨generatoræ¥éå†æ ‘,å…¶ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºå¦‚ä½•ä½¿ç”¨ç”Ÿæˆå™¨çš„é€’å½’è°ƒç”¨

```js
function* DomTraversal(element) {
  yield element;
  element = element.firstElementChild()
  while (element) {
    yield* DomTraversal(element) // å…ˆæ·±åº¦éå†
    element = element.nextElementSibling; // å†å¹¿åº¦éå†
  }
}

const head = document.getElementById('head')
for (let element of DomTraversal(head)) {
  console.log(element)
}
```
## 6 å¦‚ä½•ä¸generatorè¿›è¡Œé€šä¿¡? å°†å€¼ä¼ å…¥nextå‚æ•°ä¸­

```js
function* example3(num) {
  const num1 = yield (num + 1)
  yield (num + num1 + 1)
}

let nums = example3(1)
let num1 = nums.next().value  // 2
let num2 = nums.next(2).value // 4
```
è¿™æ ·å°±å¯ä»¥ä¸generatorè¿›è¡ŒåŒå‘é€šä¿¡, yield ä»generatorä¸­ä¼ å‡º, next(data) å°†dataä¼ å…¥åˆ°generatorä¸­.

ä½†æ˜¯è¦æ³¨æ„çš„æ˜¯,æ— æ³•å¯¹ç¬¬ä¸€ä¸ªnextè¿›è¡Œé€šä¿¡.

å› ä¸ºéœ€è¦é€šè¿‡å˜é‡æ¥ä¿å­˜ä¼ ç»™`generator`çš„æ•°æ®,ç„¶åå†ä¼ åˆ°`yield`ä¸­,å¦‚ä¸Šä¾‹ä¸­ä½¿ç”¨`num1`ä¿å­˜ä¼ å…¥æ•°æ®,å†ä¼ åˆ°ä¸‹ä¸€ä¸ª`yield`è¯­å¥ä¸­.ç”±äºç¬¬ä¸€ä¸ª`next` (`yield`)æ²¡æœ‰å˜é‡å¯ä»¥å‚¨å­˜.

ä¸è¿‡å¯ä»¥é€šè¿‡ä¼ å‚çš„æ–¹å¼å½“æˆ`initial value`ä¼ å…¥,å¦‚ä¸Šä¾‹çš„`num`

## 7 generatoræŠ›å‡ºé”™è¯¯

```js
function* example4(name) {
  try{
    yield (`my name is ${name}`)
    fail('å¦ç™½ä»å®½,æŠ—æ‹’ä»ä¸¥')
  } catch (e) {
    console.log(e)
  }
}

let iterator = example4('lorry')
const result = iterator.next().value // my name is lorry
iterator.throw('æˆ‘ä¸»åŠ¨è®¤é”™') // æ‰“å°é”™è¯¯ä¿¡æ¯.
```
## 8 generatorçš„æœ¬è´¨
- åœ¨æ‰§è¡Œgeneratorçš„æ—¶å€™å¹¶æ²¡æœ‰æ‰§è¡Œå®ƒ,è€Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç”¨äºå‘ç”Ÿæˆå™¨è¯·æ±‚å€¼çš„è¿­ä»£å™¨(iterator), generato yieldä¸€ä¸ªå€¼,ç„¶åsuspend,ç­‰å¾…ä¸‹ä¸€æ¬¡çš„nextæ‰§è¡Œ.
- åŒ…æ‹¬4ä¸ªçŠ¶æ€
  - 1 suspended start --> å½“generatoråˆ›å»ºæ—¶,æ­¤æ—¶æ²¡æœ‰ä»»ä½•generatorçš„ä»£ç è¢«æ‰§è¡Œ
  - 2 executing --> å½“nextè°ƒç”¨æ—¶
  - 3 suspended yield --> æ‰§è¡Œæ—¶,åˆ°è¾¾yieldè¯­å¥å,ä¼šåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡(eg.`{value: 1,done: false}`),generatoræš‚åœå¹¶ç­‰å¾…
  - 4 complete å½“yieldæ‰§è¡Œå®Œæ¯•çš„ä¸‹ä¸€ä¸ªnext()æˆ–è€…æ˜¾å¼returnæ—¶ è¿”å›`{value: undefined, done:true}`
## 9 æ³¨æ„ `return` åœ¨ `generator` ä¸­çš„ä½¿ç”¨
```js
function* example5() {
  yield 1
  return 2
}
function* example6() {
  yield 1
  yield 2
}
let a = example5()
for(let i of a ) {
  console.log(i) // 1,åªæœ‰ä¸€ä¸ª1
}
let b = example6()
for(let i of b) {
  console.log(i)// 1,2
}
```

# æ¥ä¸‹æ¥å°±æ˜¯Promise

## 1 å…ˆæŠ›ä¸€ä¸ªä¾‹å­

```js
const smallPromise = new Promise((resolve, reject) => {
  resolve('yes')
  // reject('an error happen to reject')
})
smallPromise.then(res => console.log(res), err => console.log(err))// yes
```
## 2 å¦‚ä½•å®ç°å¼‚æ­¥çš„åŠŸèƒ½?

```js
const asyncPromise = new Promise((resolve,reject) => {
  console.log('asyncPromise create')
  setTimeout(()=>{
    console.log('asyncPromise callback')
    resolve('async solving')
    console.log('async solved') 
  },500)
})

const immediatePromise = new Promise((resolve,reject) => {
  console.log('immediatePromise create')
  resolve('immediate solving')
  console.log('immediatePromise solved')
})

asyncPromise.then(res => console.log(res))
immediatePromise.then(res => console.log(res))
console.log('end code')
/**
asyncPromise create
 immediatePromise create
 immediatePromise solved
 end code
 immediate solving
 asyncPromise callback
 async solved
 async solving
*/
```
å¯ä»¥çœ‹åˆ°thenä¹‹åçš„è¯­å¥æ˜¯åœ¨æ‰§è¡Œå®Œæ‰€æœ‰çš„åŒæ­¥ä»£ç ä¹‹åæ‰§è¡Œ(æ³¨æ„`end code`çš„ä½ç½®)

## 3 æ˜ç›®å¼ èƒ†çš„æ‹’ç»(reject)

```js
const promise = new Promise((resolve,reject) => {
  reject('æˆ‘ä¸æƒ³ç»™ä½ ä»»ä½•æ‰¿è¯º')
})

promise.then(
  () => console.log('æˆ‘æ„¿æ„'),
  (err) => console.log(err) 
);// æˆ‘ä¸æƒ³ç»™ä½ ä»»ä½•æ‰¿è¯º
```
é™¤æ­¤ä¹‹å¤–è¿˜æœ‰`catch`çš„å†…å»ºè¯­æ³•
```js
promise
.then(() => console.log('æˆ‘æ„¿æ„'))
.catch((err) => {
  console.log(err);
})// æˆ‘ä¸æƒ³ç»™ä½ ä»»ä½•æ‰¿è¯º
```
## 4 å·å·æ‘¸æ‘¸çš„æ‹’ç»
```js
const promise = new Promise((resolve, reject) => {
  undeclareVarible++;
});
promise.then(()=>console.log('æˆ‘æ„¿æ„')).catch(() => console.log('å…¶å®æˆ‘å†…å¿ƒæ˜¯æ‹’ç»çš„'));
```
æ³¨æ„,ä¸ç®¡æ˜¯æ‹’ç»è¿˜æ˜¯æ¥æ”¶éƒ½æ˜¯ä¸€ä¸ªæœ€ç»ˆçš„ç¡®å®šæ€,promiseä¼šç”±pendingè½¬ä¸ºresolved

## 5 å®é™…çš„ä¾‹å­:

```js
function getJSON(url) {
  return new Promise((resolve, reject) => {
    const request = new XMLHttpRequest();
    request.open('get',url);
    // å¦‚æœæœåŠ¡å™¨è¿”å›äº†æ¶ˆæ¯,ä½†æ˜¯å¹¶ä¸ä»£è¡¨æ˜¯æˆ‘ä»¬é¢„æœŸçš„
    request.onload = function() {
      try {
        if (this.status === 200) {
          resolve(JSON.parse(this.response))
        } else {
          reject(this.status + ':' + this.statusText);
        }
      } catch (e) {
        reject(e.message);
      }
    }
    // å¦‚æœä¸æœåŠ¡å™¨é€šä¿¡å‡ºç°äº†é—®é¢˜
    request.onerror = function() {
      reject(this.status + ':' this.statusText)
    }
    request.send()
  })
}

getJSON('data/lorry.json').then(res => console.log('lorry got'), err => console.error('something wrong:', err))
```
## 6 é“¾å¼Promise

çœ‹äº†ä¸Šé¢çš„getJSONä¹‹å,å¯¹æœ¬æ–‡æå‡ºçš„ç¬¬ä¸€ä¸ªä¾‹å­åº”è¯¥å°±ä¼šæœ‰ä¸ä¸€æ ·çš„ç†è§£äº†

```js
getJSON('data/lorry.com')
.then(res=>getJSON(res[0].missionURL))
.then(res=>getJSON(res.missionDetaiURL))
.then(res=>console.log(res))
.catch(err=>console.error(err))
```
æ˜¯ä¸æ˜¯æ¸…çˆ½å¾ˆå¤šäº†?æ³¨æ„,é“¾å¼æ“ä½œçš„æ—¶å€™ä½¿ç”¨catchæ›´ä¸ºæ–¹ä¾¿,ä»–ä¼šå°†æ•´æ¡é“¾ä¸Šçš„ä»»ä½•é”™è¯¯éƒ½catchåˆ°,å¦‚æœä½¿ç”¨rejectå›è°ƒ,ä¼šé‡å¤æ€§çš„å†™å¾ˆå¤šé”™è¯¯handleä»£ç 

## 7 `Promise.all å’Œ Promise.race` å¦‚æœæœ‰å¤šä¸ªç›¸äº’ä¹‹é—´ä¸å¼•ç”¨çš„Promiseå¯ä»¥è¿™ä¹ˆå†™
```js
Promise.all([getJSON(url1),getJSON(url2),getJSON(url3)].then(results => {
  const res1 = results[0], res2 = results[1], res3 = results[2] // è¿”å›æ‰€æœ‰çš„ç»“æœ,åŒ…è£¹åœ¨æ•°ç»„ä¸­
}).catch(err => console.error(err))

Promise.race([getJSON(url1),getJSON(url2),getJSON(url3)].then(res => {
  console.log(res + 'is the first one finished'); // åªè¿”å›æœ€å¿«è¿”å›çš„ç»“æœ
})).catch(err=>console.error(err))
```

èƒ½çœ‹åˆ°è¿™é‡Œç›¸ä¿¡ä½ å°±èƒ½å¤Ÿç†è§£æ–‡ç« æœ€å¼€å§‹å†™çš„ä¾‹å­äº†

## æœ€å:`async` å’Œ `await` åä¸½ç™»åœº,å…¶å®æœ¬è´¨ä¸Šå°±æ˜¯ `promise` å’Œ `generator` çš„ç»“åˆ,å¯ä»¥è®©å¼‚æ­¥çš„ä»£ç å†™å¾—è·ŸåŒæ­¥ä»£ç ä¸€æ ·
```js
async function(){
  try {
    const project = await getJSON('lorry.com');
    const mission = await getJSON(project[0].missionURL);
    const missionDetail = await getJSON(mission.detailURL);
  }
}
```
async å‘Šè¯‰jså¼•æ“è¿™ä¸ªå‡½æ•°æ˜¯å¼‚æ­¥çš„å‡½æ•°,å¯ä»¥ä¸ç”¨ç­‰å¾…ç»“æœç»§ç»­æ‰§è¡Œ.

awaitè¡¨ç¤ºéœ€è¦ç­‰å¾…å¼‚æ­¥çš„è¿”å›ç»“æœä¹‹åæ‰ä¼šç»§ç»­æ‰§è¡Œ,å³æ­¤å¤„æ˜¯é˜»å¡çš„.

ç›¸å½“äºä¹‹å‰å†™çš„promise resolve ä¹‹åçš„æ‰§è¡Œè¿‡ç¨‹

await åªæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼,è·ŸåŠ å‡ä¹˜é™¤æ²¡ä»€ä¹ˆåŒºåˆ«,å“ªæ€•ä¸æ˜¯å¼‚æ­¥ä»£ç ,ä¹Ÿå¯ä»¥ä½¿ç”¨awaitç­‰,åªæ˜¯è·Ÿä¸åŠ awaitä¸€æ ·è€Œå·².

```js
function takeTime() {
  return new Promise(resolve => setTimeout(resolve(2),1000))
}

async function test() {
  /**ç›¸å½“äº
    let result
    takeTime().then(res => res = result)
    å°‘äº†ä¸ªå¤–å±‚å˜é‡çš„å£°æ˜
  */
  let result = await takeTime();
  console.log(result)
}
// è¿”å›çš„ä¾ç„¶æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡,çŠ¶æ€ä¸ºresolved
test();

// ä¹Ÿå¯ä»¥awaitåŒæ­¥ä»£ç 
function sync() {
  return 2
}
async function add() {
  const a = await takeTime() 
  const b = a + await takeTime() 
  const c = a + await sync() 
  console.log(a) // 2
  console.log(b) // 4
  console.log(c) // 4
}

function err() {
  return new Promise((resolve,reject)=>reject('æˆ‘æ˜¯æ•…æ„çš„')) 
}
async function testError () {
  let error
  await err().catch(err=> error=err) // æŠŠerr()æ˜¯ä¸ºä¸€ä¸ªpromiseå³å¯
  console.log(error)
}
```

### åœ¨è¿™é‡Œæƒ³å¼ºè°ƒä¸€ä¸ª await ä¸­ä¸€ä¸ªæ¯”è¾ƒå®¹æ˜“è·³è¿›å»çš„å‘.

```js
async function wait_for_possible() {
  await Promise(r => setTimeout(r, 1000))
  const coin = Math.random();
  if (coin > 0.5) {
    return 'yahhhh'
  } else {
    throw Error('bad luck!')
  }
}
// case 1
async function foo_1() {
  try {
    wait_for_possible()
  } catch(e) {
    return 'I caught you!'
  }
}
// case 2
async function foo_2() {
  try {
    await wait_for_possible()
  } catch(e) {
    return 'I caught you!'
  }
}
// case 3
async function foo_3() {
  try {
    return wait_for_possible()
  } catch(e) {
    return 'I caught you!'
  }
}
// case 4
async function foo_4() {
  try {
    return await wait_for_possible()
  } catch(e) {
    return 'I caught you!'
  }
  finally {
    // æŠŠæ‰€æœ‰éœ€è¦ release æ‰çš„ä¸œè¥¿æ”¾è¿™é‡Œ, åœ¨ break ä¹‹ååªæœ‰è¿™ä¸ªåœ°æ–¹ä¼šæ‰§è¡Œ.
  }
}
```

åœ¨äº try-catchè”åˆä½¿ç”¨æ—¶ä¸€å®šè¦æ³¨æ„åŒå¼‚æ­¥çš„é—®é¢˜, å› ä¸º catch åªèƒ½ catch åˆ°åŒæ­¥çš„é”™è¯¯, ä¸ç®¡æ˜¯ç›´æ¥æ‰§è¡Œ( case 1) è¿˜æ˜¯è¿”å›( case 3), éƒ½ catch ä¸åˆ°é”™è¯¯, å› ä¸º promise è¿˜åœ¨ pending, å¹¶æ²¡æœ‰é”™è¯¯, æ‰€ä»¥ foo çš„ä»£ç å·²ç»æ‰§è¡Œå®Œæ¯•, ä¹‹å throw å‡ºæ¥çš„é”™è¯¯å°±ä¼šåˆ°æœªæ•è·é”™è¯¯é‡Œ.åªæœ‰ case 2 å’Œ case 4 æ˜¯å¯ä»¥æ­£å¸¸ä½¿ç”¨å’Œæ•è·çš„.

### async ä¼šå°†æ•´ä¸ªå‡½æ•°çš„è¿”å›å€¼ğŸ“¦æˆä¸€ä¸ªPromise, ä¸ä¿¡ä½ å¯ä»¥`wait_for_possible() instanceof Promise` è¯•è¯•, è¿”å›ä¸€å®šæ˜¯ true.ä¹Ÿå°±æ˜¯è¯´ async æœ¬èº«å°±æ˜¯promise.wrap çš„ä¸€ç§å®ç°æ–¹å¼

### for-await, å¯ä»¥åœ¨å¾ªç¯ä¸­ä½¿ç”¨ await, ä¿è¯æ¯ä¸ª iterator éƒ½å†³è®®å®Œæ¯•ä¹‹åå†è¿›å…¥å¾ªç¯.å¯ä»¥å°†ç”Ÿæˆå™¨å’Œ async-await ç»“åˆ
```js
async function* asyncRandomNumber() {
  const url = 'https://www.random.org/decimal-fractions/?num=1&dec=10&col=1&format=plain&rnd=new';
  while(true) {
    const response = await fetch(url);
    // è¯¥ text ä¹Ÿä¸ºå¼‚æ­¥æ–¹æ³•
    const text = await response.text();
    yield Number(text)
  }
}

async function foo() {
  for await (const number of asyncRandomNumber()) {
    console.log(number)
    if (number > 0.9) break;
  }
}

foo()
```
### ä½¿ç”¨ [Symbol.asyncIterator]
```js
function streamAsyncIterator(stream) {
  let i = 0;
  return {
    next() {
      // Stream reads already resolve with {done, value}, so
      // we can just call read:
      return {done:false, value: i++}
    },
    return() {
      // Release the lock if the iterator terminates.
      return {done:true, value: 'iterator done'};
    },
    // for-await calls this on whatever it's passed, so
    // iterators tend to return themselves.
    [Symbol.asyncIterator]() {
      return this;
    }
  };
}

async function foo() {
  for await (const a of streamAsyncIterator()) {
    if (a > 10) {
      return a;
    }
    console.log(a)
  }
}

foo().then(v => console.log(v))
```
ä¸Šè¿°ä»£ç æ‰“å°çš„ç»“æœä¸º 0,1,2,3,4,5,6,7,8,9,10, 11


## æ—¢ç„¶Promiseé‚£ä¹ˆä¼˜ç§€, å¯ä»¥å®ç°å¼‚æ­¥ä¸­æ§åˆ¶æƒçš„åè½¬å†åè½¬, è¿˜å¯ä¿¡. æœ‰æ²¡æœ‰ä¸€ç§åŠæ³•å¯ä»¥ç›´æ¥å°†æ™®é€šçš„å›è°ƒå‡½æ•°è½¬åŒ–ä¸ºPromiseå‘¢?å¯ä»¥å€ŸåŠ©ä¸€äº›ç¬¬ä¸‰æ–¹åº“,ä¹Ÿå¯ä»¥è‡ªå·±å†™ä¸€ä¸ªç®€å•çš„Promise.wrapå‡½æ•°, å‡è®¾å›è°ƒéƒ½æ˜¯`error-first`çš„é£æ ¼

```js
if(!Promise.wrap) {
  Promise.wrap = fn => (...args) => new Promise((resolve, reject) => {
    fn.apply(null, args.concat((err, value) => {
      err && reject(err)
      resolve(value)
    }))
  })
}
```
è¿™æ ·å°±å®Œæˆäº†ä¸€ä¸ªç®€å•çš„å°è£…, ä¹Ÿæ˜¯é«˜é˜¶å‡½æ•°çš„åº”ç”¨.

æ¥ä¸‹æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨å§
```js
function fake(a, b, cb) {
  setTimeout(()=> cb(a,b), 2000);
}
const wrapFunc = Promise.wrap(fake)
wrapFunc(null, 2).then((res) => console.log(res)); // 2såæ‰“å°2
```

## generatorä¸­çš„è¾…åŠ©å‡½æ•°
### step
```js
function step(gen) {
  // é—­åŒ…
  const it = gen();
  let last;
  return (value) => {
    // ä¸ç®¡yieldå‡ºæ¥çš„æ˜¯ä»€ä¹ˆéƒ½ä¼šä¼ å›å»
    last = it.next(value).value;
    return last
  }
}
// ä½¿ç”¨æ–¹æ³•
let i = 1;
function *gen1() {
  while(true) {
    yield (i ++)
  }
}
function *gen2() {
  let x = yield (i = i + 2);
  yield x * 10
}
let newGen1 = step(gen1)
let newGen2 = step(gen2)
newGen1() // 1
newGen1() // 2
newGen1() // 3
newGen2() // 6
newGen2(10) // 100
newGen1() // 6
```
ç›¸ä¿¡åœ¨å¼€å‘ä¸­ä¸ä¼šå†™è¿™æ ·çš„ä»£ç ,åªæ˜¯ä¸ºäº†æ›´å¥½çš„æ¼”ç¤ºæ§åˆ¶æƒåœ¨ç”Ÿæˆå™¨ä¸­çš„äº¤æ¢ä»¥åŠä¿¡æ¯çš„ä¼ é€’
## ES6ä¸­æœ‰ä¸€ä¸ªæ–°çš„åŸºæœ¬ç±»å‹ `Symbol`, 

```js

let something = (() => {
  let nextVal = 0;
  return {
    [Symbol.iterator]: function() {return this},
    next: () => {
      if (nextVal === 0) {
        nextVal = 1
      } else {
        nextVal = (3 * nextVal)
      }
      return {done: false, value: nextVal}
    }
  }
})();
// è¿˜å¯ä»¥æŠŠiteratoræŠ½ç¦»å‡ºæ¥
let nextObj = {
  nextVal: 0,
  next: function() {
      if (this.nextVal === 0) {
        this.nextVal += 1
      } else {
        this.nextVal *= 3
      }
      return {done: false, value: this.nextVal}
    },
}
let something = (() => {
  return {
    [Symbol.iterator]: () => nextObj,
  }
})()
```
somethingå°±æ˜¯ä¸€ä¸ªå¯è¿­ä»£çš„å¯¹è±¡, å¹¶ä¸”æ°¸è¿œå¯è¿­ä»£.ä½¿ç”¨`for...of`æ¥çœ‹çœ‹
```js
for (let ret of something) {
  if (ret < 100) {
    console.log(ret)
  } else {
    break;
  }
}
```
æ¯ä¸€ä¸ªå¯è¿­ä»£çš„å¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ª`[Symbol.iterator]`, ç”¨æ¥æ¯æ¬¡è¿­ä»£çš„æ—¶å€™è¿”å›çš„å†…å®¹, ä¼šè°ƒç”¨nextæ–¹æ³•, å¹¶å°†æœ€åreturnçš„valueå€¼ä¼ å›.è€Œä¸”ä¼šä¿å­˜çŠ¶æ€
```js
let a = [1,2,3,4]
const it = a[Symbol.iterator]()
it.next().value; // 1
for (let i of it) {
  console.log(i); // 2,3,4 
}
```
`[Symbol.iterator]`ä»åŒä¸€ä¸ªiteratorå¯¹è±¡å‡ºæ¥çš„é“¾å¼`[Symbol.iterator]`æ¯ä¸€ä¸ªä¸åŒä½†æ˜¯æ•ˆæœç›¸åŒ
```js
let a = [1,2,3,4]
const it = a[Symbol.iterator]()
const it2 = it[Symbol.iterator]()
const it3 = it2[Symbol.iterator]()
const it4 = it[Symbol.iterator]()
Boolean(it == it2 || it2 == it3 || it3 == it4) // false
it.next().value;// 1
it2.next().value;// 2
it3.next().value;// 3
it4.next().value;// 4
```

### æ³¨æ„ä¸Šè¿°çš„ä¾‹å­ä¸­ä½¿ç”¨äº†breakæ¥é˜»æ­¢æ­»å¾ªç¯,å…¶å®generatorè‡ªå·±æœ‰ä¸€ä¸ªè·³å‡ºå¾ªç¯çš„æ–¹æ³•, it.return()
```js
function *something() {
  try {
    let nextVal = 0;
    while(true) {
      if (nextVal === 0) {
        nextVal += 1
      } else {
        nextVal *= 3
      }
      yield nextVal
    }
  }
  finally {
    console.log('clean up')
  }
}
const it = something()
for (let ret of it) {
  if (ret < 100) {
    console.log(ret)
  } else {
    console.log(it.return('hello world').value)
  }
}
```